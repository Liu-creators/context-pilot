# Canvas åŠŸèƒ½å®ç°æ¸…å•

> æœ¬æ–‡æ¡£è®°å½• AI Companion æ’ä»¶åœ¨ Canvas ç”»å¸ƒä¸­éœ€è¦å®ç°çš„åŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨ Canvas ç”»å¸ƒä¸­é€šè¿‡èŠ‚ç‚¹èœå•æŒ‰é’®è§¦å‘ AIï¼Œç”¨æˆ·è¾“å…¥é—®é¢˜ååˆ›å»ºæ–°çš„æ–‡æœ¬èŠ‚ç‚¹æ˜¾ç¤º AI å“åº”ã€‚æ”¯æŒé€šè¿‡ä¸åŒå¿«æ·é”®æ§åˆ¶ä¸Šä¸‹æ–‡èŒƒå›´ã€‚

## ğŸ’¡ è®¾è®¡æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
1. **é¿å…ç„¦ç‚¹é—®é¢˜**ï¼šä¸åœ¨èŠ‚ç‚¹å†…éƒ¨è¾“å…¥æ—¶è§¦å‘ï¼Œè€Œæ˜¯é€šè¿‡èŠ‚ç‚¹èœå•æŒ‰é’®è§¦å‘
2. **å¼¹çª—è¾“å…¥**ï¼šç‚¹å‡»æŒ‰é’®åå¼¹å‡ºè¾“å…¥æ¡†ï¼Œç”¨æˆ·è¾“å…¥é—®é¢˜
3. **æ–°èŠ‚ç‚¹å“åº”**ï¼šAI å“åº”åˆ›å»ºä¸ºæ–°çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œè‡ªåŠ¨è¿æ¥åˆ°è§¦å‘èŠ‚ç‚¹
4. **å¿«æ·é”®æ§åˆ¶ä¸Šä¸‹æ–‡**ï¼šåœ¨è¾“å…¥æ¡†ä¸­é€šè¿‡ä¸åŒå¿«æ·é”®æäº¤ï¼Œæ§åˆ¶ä¸Šä¸‹æ–‡èŒƒå›´
5. **å¹¶å‘æ”¯æŒ**ï¼šæ”¯æŒå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆå“åº”ï¼Œäº’ä¸å¹²æ‰°

### ä¸Šä¸‹æ–‡èŒƒå›´
- **ä»…å½“å‰èŠ‚ç‚¹**ï¼ˆEnterï¼‰ï¼šåªåŒ…å«è§¦å‘èŠ‚ç‚¹çš„å†…å®¹
- **åŒ…å«ç›¸å…³èŠ‚ç‚¹**ï¼ˆShift+Enterï¼‰ï¼šåŒ…å«è§¦å‘èŠ‚ç‚¹ + æ‰€æœ‰è¿æ¥çš„èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ï¼‰

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 1. Canvas èŠ‚ç‚¹èœå•é›†æˆ

#### 1.1 æ·»åŠ èœå•æŒ‰é’®
- [ ] åœ¨ Canvas èŠ‚ç‚¹èœå•ä¸­æ·»åŠ  "AI åŠ©æ‰‹" æŒ‰é’®
- [ ] æŒ‰é’®å›¾æ ‡ï¼šä½¿ç”¨ AI ç›¸å…³å›¾æ ‡ï¼ˆå¦‚ `bot` æˆ– `sparkles`ï¼‰
- [ ] æŒ‰é’®ä½ç½®ï¼šä¸å…¶ä»–èŠ‚ç‚¹æ“ä½œæŒ‰é’®å¹¶åˆ—
- [ ] æ”¯æŒæ‰€æœ‰ç±»å‹çš„èŠ‚ç‚¹ï¼ˆæ–‡æœ¬ã€æ–‡ä»¶ã€åª’ä½“ç­‰ï¼‰

#### 1.2 æŒ‰é’®è¡Œä¸º
- [ ] ç‚¹å‡»æŒ‰é’®æ‰“å¼€è¾“å…¥æ¨¡æ€æ¡†
- [ ] è®°å½•è§¦å‘çš„èŠ‚ç‚¹å¼•ç”¨
- [ ] æŒ‰é’®çŠ¶æ€ï¼šç”Ÿæˆä¸­æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

### 2. è¾“å…¥æ¨¡æ€æ¡†

#### 2.1 æ¨¡æ€æ¡† UI
- [ ] åˆ›å»ºä¸“ç”¨çš„ Canvas AI è¾“å…¥æ¨¡æ€æ¡†
- [ ] æ˜¾ç¤ºè§¦å‘èŠ‚ç‚¹çš„æ ‡é¢˜/é¢„è§ˆï¼ˆè®©ç”¨æˆ·çŸ¥é“ä¸Šä¸‹æ–‡æ¥æºï¼‰
- [ ] å¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†ï¼ˆæ”¯æŒè¾ƒé•¿çš„é—®é¢˜ï¼‰
- [ ] æ˜¾ç¤ºå¿«æ·é”®æç¤º
  - `Enter`ï¼šä»…å½“å‰èŠ‚ç‚¹
  - `Shift+Enter`ï¼šåŒ…å«ç›¸å…³èŠ‚ç‚¹
- [ ] å–æ¶ˆæŒ‰é’®

#### 2.2 è¾“å…¥å¤„ç†
- [ ] æ•è·ç”¨æˆ·è¾“å…¥
- [ ] æ”¯æŒ Markdown æ ¼å¼ï¼ˆå¯é€‰ï¼‰
- [ ] æ”¯æŒåŒé“¾è¯­æ³• `[[]]`ï¼ˆå¯é€‰ï¼‰
- [ ] éªŒè¯è¾“å…¥ä¸ä¸ºç©º
- [ ] æ”¯æŒ ESC é”®å…³é—­

#### 2.3 å¿«æ·é”®å¤„ç†
- [ ] æ³¨å†Œ `Enter` é”®ï¼šæäº¤ï¼ˆä»…å½“å‰èŠ‚ç‚¹ä¸Šä¸‹æ–‡ï¼‰
- [ ] æ³¨å†Œ `Shift+Enter` é”®ï¼šæäº¤ï¼ˆåŒ…å«ç›¸å…³èŠ‚ç‚¹ä¸Šä¸‹æ–‡ï¼‰
- [ ] é˜»æ­¢é»˜è®¤æ¢è¡Œè¡Œä¸º
- [ ] æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„ä¸Šä¸‹æ–‡èŒƒå›´

### 3. ä¸Šä¸‹æ–‡æå–

#### 3.1 å½“å‰èŠ‚ç‚¹ä¸Šä¸‹æ–‡
- [ ] æå–è§¦å‘èŠ‚ç‚¹çš„å®Œæ•´æ–‡æœ¬å†…å®¹
- [ ] å¤„ç†ä¸åŒç±»å‹çš„èŠ‚ç‚¹
  - æ–‡æœ¬èŠ‚ç‚¹ï¼šæå–æ–‡æœ¬å†…å®¹
  - æ–‡ä»¶èŠ‚ç‚¹ï¼šæå–æ–‡ä»¶åå’Œè·¯å¾„ï¼ˆå¯é€‰ï¼šè¯»å–æ–‡ä»¶å†…å®¹ï¼‰
  - åª’ä½“èŠ‚ç‚¹ï¼šæå–æ–‡ä»¶åå’Œç±»å‹
- [ ] é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆä½¿ç”¨è®¾ç½®ä¸­çš„ maxContextLengthï¼‰

#### 3.2 ç›¸å…³èŠ‚ç‚¹ä¸Šä¸‹æ–‡
- [ ] è¯†åˆ«æ‰€æœ‰è¿æ¥åˆ°è§¦å‘èŠ‚ç‚¹çš„èŠ‚ç‚¹
  - çˆ¶èŠ‚ç‚¹ï¼ˆincoming edgesï¼‰
  - å­èŠ‚ç‚¹ï¼ˆoutgoing edgesï¼‰
- [ ] æå–æ¯ä¸ªç›¸å…³èŠ‚ç‚¹çš„å†…å®¹
- [ ] æ„å»ºç»“æ„åŒ–çš„ä¸Šä¸‹æ–‡
  ```
  --- å½“å‰èŠ‚ç‚¹ ---
  [è§¦å‘èŠ‚ç‚¹å†…å®¹]
  
  --- çˆ¶èŠ‚ç‚¹ ---
  [çˆ¶èŠ‚ç‚¹1å†…å®¹]
  [çˆ¶èŠ‚ç‚¹2å†…å®¹]
  
  --- å­èŠ‚ç‚¹ ---
  [å­èŠ‚ç‚¹1å†…å®¹]
  [å­èŠ‚ç‚¹2å†…å®¹]
  ```
- [ ] é™åˆ¶æ€»ä¸Šä¸‹æ–‡é•¿åº¦
- [ ] é™åˆ¶èŠ‚ç‚¹æ•°é‡ï¼ˆé¿å…è¿‡å¤§çš„ç”»å¸ƒå¯¼è‡´ä¸Šä¸‹æ–‡è¿‡é•¿ï¼‰

### 4. å“åº”èŠ‚ç‚¹åˆ›å»º

#### 4.1 æ–°èŠ‚ç‚¹åˆ›å»º
- [ ] åˆ›å»ºæ–°çš„æ–‡æœ¬èŠ‚ç‚¹æ˜¾ç¤º AI å“åº”
- [ ] è‡ªåŠ¨è¿æ¥åˆ°è§¦å‘èŠ‚ç‚¹ï¼ˆåˆ›å»º edgeï¼‰
- [ ] è®¾ç½®èŠ‚ç‚¹ä½ç½®
  - åœ¨è§¦å‘èŠ‚ç‚¹ä¸‹æ–¹
  - åç§»é‡å¯é…ç½®ï¼ˆé»˜è®¤ï¼šx: 0, y: 150ï¼‰
  - é¿å…ä¸ç°æœ‰èŠ‚ç‚¹é‡å 
- [ ] è®¾ç½®èŠ‚ç‚¹å¤§å°
  - æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´
  - æˆ–ä½¿ç”¨å›ºå®šå¤§å°ï¼ˆå¯é…ç½®ï¼‰

#### 4.2 å“åº”æ ¼å¼
- [ ] ç›´æ¥ä½¿ç”¨ AI è¿”å›çš„å®Œæ•´ Obsidian Markdown å†…å®¹
- [ ] ä¸æ·»åŠ é¢å¤–çš„åŒ…è£…æˆ–æ ¼å¼
- [ ] æ”¯æŒæ‰€æœ‰ Obsidian Markdown è¯­æ³•
  - æ ‡é¢˜ã€åˆ—è¡¨ã€å¼•ç”¨
  - ä»£ç å—å’Œè¯­æ³•é«˜äº®
  - è¡¨æ ¼ã€é“¾æ¥ã€å›¾ç‰‡
  - Calloutï¼ˆå¦‚æœ AI è¿”å›ï¼‰
  - åŒé“¾ `[[]]`
  - æ ‡ç­¾ `#tag`
  - æ•°å­¦å…¬å¼
  - Mermaid å›¾è¡¨
- [ ] ä¿æŒ AI è¾“å‡ºçš„åŸå§‹æ ¼å¼å’Œç»“æ„

#### 4.3 æµå¼è¾“å‡º
- [ ] åˆ›å»ºèŠ‚ç‚¹æ—¶å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
  ```markdown
  â³ æ­£åœ¨æ€è€ƒ...
  ```
- [ ] å®æ—¶æ›´æ–°èŠ‚ç‚¹å†…å®¹ï¼ˆé€å­—æ˜¾ç¤º AI è¿”å›çš„ Obsidian Markdownï¼‰
- [ ] å®Œæˆåæ˜¾ç¤ºå®Œæ•´çš„ Markdown å†…å®¹ï¼ˆåŒ…æ‹¬ calloutã€åŒé“¾ç­‰æ‰€æœ‰è¯­æ³•ï¼‰
- [ ] åŠ¨æ€æ›´æ–°èŠ‚ç‚¹å¤§å°ä»¥é€‚åº”å†…å®¹å˜åŒ–
- [ ] æ­£ç¡®æ¸²æŸ“ Obsidian ç‰¹æœ‰è¯­æ³•ï¼ˆcalloutã€åŒé“¾ç­‰ï¼‰

#### 4.4 å¹¶å‘æ”¯æŒ
- [ ] æ”¯æŒå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆå“åº”
- [ ] æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ç®¡ç†
- [ ] ä½¿ç”¨è¯·æ±‚ ID è·Ÿè¸ªæ¯ä¸ªç”Ÿæˆä»»åŠ¡
- [ ] äº’ä¸å¹²æ‰°ï¼Œå„è‡ªæ›´æ–°å¯¹åº”çš„å“åº”èŠ‚ç‚¹

### 5. é”™è¯¯å¤„ç†

#### 5.1 é”™è¯¯èŠ‚ç‚¹åˆ›å»º
- [ ] åˆ›å»ºé”™è¯¯èŠ‚ç‚¹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- [ ] ä½¿ç”¨ç®€æ´çš„é”™è¯¯æ ¼å¼
  ```markdown
  âŒ AI é”™è¯¯
  
  é”™è¯¯ä¿¡æ¯...
  
  ---
  æç¤ºï¼šå¯ä»¥é‡æ–°ç‚¹å‡»èŠ‚ç‚¹èœå•æŒ‰é’®é‡è¯•
  ```
- [ ] è¿æ¥åˆ°è§¦å‘èŠ‚ç‚¹
- [ ] æä¾›é‡è¯•è¯´æ˜

#### 5.2 é”™è¯¯ç±»å‹å¤„ç†
- [ ] API è¿æ¥é”™è¯¯
- [ ] è¶…æ—¶é”™è¯¯
- [ ] ä¸Šä¸‹æ–‡è¿‡é•¿é”™è¯¯
- [ ] å–æ¶ˆè¯·æ±‚ï¼ˆç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼‰

#### 5.3 ç”¨æˆ·é€šçŸ¥
- [ ] æ˜¾ç¤º Notice é€šçŸ¥
- [ ] åœ¨æ§åˆ¶å°è®°å½•è¯¦ç»†é”™è¯¯
- [ ] æä¾›é”™è¯¯æ¢å¤å»ºè®®

### 6. Canvas API é›†æˆ

#### 6.1 Canvas è®¿é—®
- [ ] è·å–å½“å‰æ´»è·ƒçš„ Canvas å®ä¾‹
  ```typescript
  const canvas = app.workspace.getActiveViewOfType(ItemView)?.canvas
  ```
- [ ] éªŒè¯ Canvas æ˜¯å¦å¯ç”¨
- [ ] å¤„ç† Canvas æœªæ‰“å¼€çš„æƒ…å†µ

#### 6.2 èŠ‚ç‚¹æ“ä½œ
- [ ] è¯»å–èŠ‚ç‚¹å†…å®¹
  ```typescript
  node.text // æ–‡æœ¬èŠ‚ç‚¹
  node.file // æ–‡ä»¶èŠ‚ç‚¹
  ```
- [ ] åˆ›å»ºæ–°èŠ‚ç‚¹
  ```typescript
  canvas.createTextNode(position, size, content)
  ```
- [ ] æ›´æ–°èŠ‚ç‚¹å†…å®¹
  ```typescript
  canvas.updateNode(node, { text: newContent })
  ```
- [ ] è®¾ç½®èŠ‚ç‚¹ä½ç½®å’Œå¤§å°

#### 6.3 è¿æ¥ï¼ˆEdgeï¼‰æ“ä½œ
- [ ] åˆ›å»ºèŠ‚ç‚¹è¿æ¥
  ```typescript
  canvas.createEdge(fromNode, toNode)
  ```
- [ ] è·å–èŠ‚ç‚¹çš„æ‰€æœ‰è¿æ¥
  ```typescript
  canvas.edges.filter(edge => 
    edge.from.node.id === nodeId || edge.to.node.id === nodeId
  )
  ```
- [ ] è¯†åˆ«çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹

#### 6.4 äº‹ä»¶ç›‘å¬
- [ ] ç›‘å¬ Canvas æ‰“å¼€/å…³é—­äº‹ä»¶
- [ ] ç›‘å¬èŠ‚ç‚¹åˆ›å»º/åˆ é™¤äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
- [ ] æ¸…ç†äº‹ä»¶ç›‘å¬å™¨ï¼ˆåœ¨æ’ä»¶å¸è½½æ—¶ï¼‰

## ğŸ”§ æŠ€æœ¯å®ç°

### æ–‡ä»¶ç»“æ„

```
src/canvas/
â”œâ”€â”€ index.ts                      # Canvas æ¨¡å—å¯¼å‡º
â”œâ”€â”€ canvas-menu-handler.ts        # èŠ‚ç‚¹èœå•æŒ‰é’®å¤„ç†
â”œâ”€â”€ canvas-input-modal.ts         # AI è¾“å…¥æ¨¡æ€æ¡†
â”œâ”€â”€ canvas-ui-controller.ts       # Canvas UI æ§åˆ¶å™¨
â”œâ”€â”€ canvas-context-extractor.ts   # Canvas ä¸Šä¸‹æ–‡æå–
â””â”€â”€ canvas-node-manager.ts        # Canvas èŠ‚ç‚¹ç®¡ç†å’Œåˆ›å»º
```

### æ ¸å¿ƒç±»

#### CanvasMenuHandler
```typescript
class CanvasMenuHandler {
  // æ³¨å†ŒèŠ‚ç‚¹èœå•é¡¹
  registerNodeMenu(): void
  
  // å¤„ç†èœå•ç‚¹å‡»
  handleMenuClick(node: CanvasNode): void
  
  // æ‰“å¼€è¾“å…¥æ¨¡æ€æ¡†
  openInputModal(node: CanvasNode): void
  
  // æ¸…ç†
  cleanup(): void
}
```

#### CanvasInputModal
```typescript
class CanvasInputModal extends Modal {
  // æ„é€ å‡½æ•°
  constructor(app: App, triggerNode: CanvasNode, onSubmit: (prompt: string, includeRelated: boolean) => void)
  
  // æ‰“å¼€æ¨¡æ€æ¡†
  onOpen(): void
  
  // å…³é—­æ¨¡æ€æ¡†
  onClose(): void
  
  // å¤„ç†æäº¤ï¼ˆEnterï¼‰
  handleSubmit(includeRelated: boolean): void
  
  // æ˜¾ç¤ºå¿«æ·é”®æç¤º
  renderShortcutHints(): void
}
```

#### CanvasUIController
```typescript
class CanvasUIController {
  // æäº¤ prompt åˆ° AI
  async submitPrompt(
    canvas: Canvas,
    triggerNode: CanvasNode, 
    prompt: string, 
    includeRelated: boolean
  ): Promise<void>
  
  // åˆ›å»ºå“åº”èŠ‚ç‚¹ï¼ˆåŠ è½½çŠ¶æ€ï¼‰
  createResponseNode(
    canvas: Canvas,
    triggerNode: CanvasNode,
    prompt: string
  ): CanvasNode
  
  // æ›´æ–°å“åº”èŠ‚ç‚¹ï¼ˆæµå¼ï¼‰
  updateResponseNode(
    canvas: Canvas,
    responseNode: CanvasNode,
    content: string,
    isComplete: boolean
  ): void
  
  // åˆ›å»ºé”™è¯¯èŠ‚ç‚¹
  createErrorNode(
    canvas: Canvas,
    triggerNode: CanvasNode,
    error: Error
  ): void
  
  // ç®¡ç†å¹¶å‘è¯·æ±‚
  private activeRequests: Map<string, CancelToken>
}
```

#### CanvasContextExtractor
```typescript
class CanvasContextExtractor {
  // æå–èŠ‚ç‚¹å†…å®¹
  extractNodeContent(node: CanvasNode): string
  
  // æå–å½“å‰èŠ‚ç‚¹ä¸Šä¸‹æ–‡
  extractCurrentNodeContext(node: CanvasNode): string
  
  // æå–ç›¸å…³èŠ‚ç‚¹ä¸Šä¸‹æ–‡
  extractRelatedNodesContext(
    canvas: Canvas,
    node: CanvasNode
  ): string
  
  // è·å–è¿æ¥çš„èŠ‚ç‚¹
  getConnectedNodes(
    canvas: Canvas,
    node: CanvasNode
  ): { parents: CanvasNode[], children: CanvasNode[] }
  
  // é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦
  private truncateContext(context: string, maxLength: number): string
}
```

#### CanvasNodeManager
```typescript
class CanvasNodeManager {
  // è·å–å½“å‰æ´»è·ƒçš„ Canvas
  getActiveCanvas(): Canvas | null
  
  // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
  createTextNode(
    canvas: Canvas,
    content: string,
    position: { x: number, y: number },
    size?: { width: number, height: number }
  ): CanvasNode
  
  // åˆ›å»ºè¿æ¥
  createEdge(
    canvas: Canvas,
    fromNode: CanvasNode,
    toNode: CanvasNode
  ): void
  
  // è®¡ç®—æ–°èŠ‚ç‚¹ä½ç½®
  calculateNodePosition(
    triggerNode: CanvasNode,
    offset: { x: number, y: number }
  ): { x: number, y: number }
  
  // æ›´æ–°èŠ‚ç‚¹å†…å®¹
  updateNodeContent(
    canvas: Canvas,
    node: CanvasNode,
    content: string
  ): void
  
  // è°ƒæ•´èŠ‚ç‚¹å¤§å°
  resizeNode(
    canvas: Canvas,
    node: CanvasNode,
    content: string
  ): void
}
```

## âš™ï¸ è®¾ç½®é…ç½®

### Canvas ä¸“å±è®¾ç½®

```typescript
interface CanvasSettings {
  // æ˜¯å¦å¯ç”¨ Canvas åŠŸèƒ½
  enabled: boolean;
  
  // æ–°èŠ‚ç‚¹ä½ç½®åç§»
  newNodeOffset: { x: number; y: number };
  
  // æ–°èŠ‚ç‚¹é»˜è®¤å¤§å°
  newNodeSize: { width: number; height: number };
  
  // æ˜¯å¦è‡ªåŠ¨è°ƒæ•´èŠ‚ç‚¹å¤§å°
  autoResizeNode: boolean;
  
  // æœ€å¤§ç›¸å…³èŠ‚ç‚¹æ•°é‡ï¼ˆé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿ï¼‰
  maxRelatedNodes: number;
}
```

### é»˜è®¤é…ç½®

```typescript
const DEFAULT_CANVAS_SETTINGS: CanvasSettings = {
  enabled: true,
  newNodeOffset: { x: 0, y: 150 },
  newNodeSize: { width: 400, height: 200 },
  autoResizeNode: true,
  maxRelatedNodes: 10
};
```

### è®¾ç½®ç•Œé¢

- [ ] æ·»åŠ  Canvas è®¾ç½®åˆ†ç»„
- [ ] å¯ç”¨/ç¦ç”¨ Canvas åŠŸèƒ½å¼€å…³
- [ ] æ–°èŠ‚ç‚¹ä½ç½®åç§»é…ç½®ï¼ˆx, yï¼‰
- [ ] æ–°èŠ‚ç‚¹å¤§å°é…ç½®ï¼ˆwidth, heightï¼‰
- [ ] è‡ªåŠ¨è°ƒæ•´èŠ‚ç‚¹å¤§å°å¼€å…³
- [ ] æœ€å¤§ç›¸å…³èŠ‚ç‚¹æ•°é‡é…ç½®

## ğŸ§ª æµ‹è¯•éœ€æ±‚

### å•å…ƒæµ‹è¯•
- [ ] ä¸Šä¸‹æ–‡æå–æµ‹è¯•
  - å½“å‰èŠ‚ç‚¹å†…å®¹æå–
  - ç›¸å…³èŠ‚ç‚¹è¯†åˆ«
  - ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶
- [ ] èŠ‚ç‚¹ä½ç½®è®¡ç®—æµ‹è¯•
- [ ] èŠ‚ç‚¹å†…å®¹æ ¼å¼åŒ–æµ‹è¯•

### é›†æˆæµ‹è¯•
- [ ] èœå•æŒ‰é’®ç‚¹å‡»æµ‹è¯•
- [ ] æ¨¡æ€æ¡†è¾“å…¥å’Œæäº¤æµ‹è¯•
- [ ] AI è¯·æ±‚å’Œå“åº”æµ‹è¯•
- [ ] æ–°èŠ‚ç‚¹åˆ›å»ºå’Œè¿æ¥æµ‹è¯•
- [ ] å¹¶å‘è¯·æ±‚æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

### æ‰‹åŠ¨æµ‹è¯•åœºæ™¯
- [ ] å•ä¸ªèŠ‚ç‚¹ç”Ÿæˆå“åº”
- [ ] å¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆå“åº”
- [ ] åŒ…å«ç›¸å…³èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡
- [ ] ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼ˆæ–‡æœ¬ã€æ–‡ä»¶ã€åª’ä½“ï¼‰
- [ ] å¤æ‚çš„èŠ‚ç‚¹å…³ç³»ï¼ˆå¤šä¸ªçˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ï¼‰
- [ ] å¤§å‹ç”»å¸ƒæ€§èƒ½æµ‹è¯•
- [ ] é”™è¯¯åœºæ™¯ï¼ˆAPI å¤±è´¥ã€è¶…æ—¶ç­‰ï¼‰
- [ ] å–æ¶ˆç”Ÿæˆä¸­çš„è¯·æ±‚

## ğŸ“ å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
1. âœ… Canvas èŠ‚ç‚¹èœå•æŒ‰é’®é›†æˆ
2. âœ… è¾“å…¥æ¨¡æ€æ¡†ï¼ˆåŸºç¡€ç‰ˆï¼‰
3. âœ… å½“å‰èŠ‚ç‚¹ä¸Šä¸‹æ–‡æå–
4. âœ… æ–°èŠ‚ç‚¹åˆ›å»ºå’Œè¿æ¥
5. âœ… åŸºç¡€å“åº”æ˜¾ç¤ºï¼ˆéæµå¼ï¼‰

### P1 - é‡è¦åŠŸèƒ½ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
6. âœ… ç›¸å…³èŠ‚ç‚¹ä¸Šä¸‹æ–‡æå–
7. âœ… å¿«æ·é”®æ”¯æŒï¼ˆEnter / Shift+Enterï¼‰
8. âœ… æµå¼è¾“å‡ºæ”¯æŒ
9. âœ… é”™è¯¯å¤„ç†å’Œé”™è¯¯èŠ‚ç‚¹
10. âœ… Canvas ä¸“å±è®¾ç½®

### P2 - å¢å¼ºåŠŸèƒ½ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰
11. å¹¶å‘è¯·æ±‚ç®¡ç†å’ŒçŠ¶æ€è·Ÿè¸ª
12. èŠ‚ç‚¹è‡ªåŠ¨è°ƒæ•´å¤§å°
13. æ™ºèƒ½èŠ‚ç‚¹ä½ç½®ï¼ˆé¿å…é‡å ï¼‰
14. å–æ¶ˆè¯·æ±‚åŠŸèƒ½
15. æ›´ä¸°å¯Œçš„é”™è¯¯æç¤ºå’Œæ¢å¤é€‰é¡¹

## ğŸš§ å·²çŸ¥æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆ

### æŠ€æœ¯æŒ‘æˆ˜

#### 1. Canvas API è®¿é—®
- **æŒ‘æˆ˜**ï¼šCanvas API å¯èƒ½ä¸å®Œå…¨å…¬å¼€
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ç ”ç©¶ Obsidian å†…éƒ¨ API
  - å‚è€ƒå…¶ä»– Canvas æ’ä»¶çš„å®ç°
  - ä½¿ç”¨ç±»å‹æ–­è¨€è®¿é—®ç§æœ‰ APIï¼ˆå¦‚æœå¿…è¦ï¼‰

#### 2. èŠ‚ç‚¹èœå•é›†æˆ
- **æŒ‘æˆ˜**ï¼šå¦‚ä½•åœ¨èŠ‚ç‚¹èœå•ä¸­æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨ `workspace.on('canvas:node-menu')` äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  - æˆ–é€šè¿‡ Canvas å®ä¾‹çš„ API æ³¨å†Œèœå•é¡¹
  - å‚è€ƒ Obsidian æ–‡æ¡£å’Œç¤¾åŒºæ’ä»¶ç¤ºä¾‹

#### 3. å¹¶å‘è¯·æ±‚ç®¡ç†
- **æŒ‘æˆ˜**ï¼šå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆï¼Œå¦‚ä½•ç®¡ç†çŠ¶æ€
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨ Map å­˜å‚¨æ¯ä¸ªè¯·æ±‚çš„çŠ¶æ€
  - è¯·æ±‚ ID å…³è”åˆ°å“åº”èŠ‚ç‚¹
  - ç‹¬ç«‹çš„å–æ¶ˆä»¤ç‰Œï¼ˆCancelTokenï¼‰

#### 4. èŠ‚ç‚¹ä½ç½®è®¡ç®—
- **æŒ‘æˆ˜**ï¼šé¿å…æ–°èŠ‚ç‚¹ä¸ç°æœ‰èŠ‚ç‚¹é‡å 
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ç®€å•æ–¹æ¡ˆï¼šå›ºå®šåç§»é‡ï¼ˆy: 150ï¼‰
  - é«˜çº§æ–¹æ¡ˆï¼šæ£€æµ‹å‘¨å›´èŠ‚ç‚¹ï¼ŒåŠ¨æ€è°ƒæ•´ä½ç½®

### ç”¨æˆ·ä½“éªŒæŒ‘æˆ˜

#### 1. ä¸Šä¸‹æ–‡ç†è§£
- **æŒ‘æˆ˜**ï¼šç”¨æˆ·å¯èƒ½ä¸æ¸…æ¥š"ç›¸å…³èŠ‚ç‚¹"åŒ…å«å“ªäº›
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºå°†è¦åŒ…å«çš„èŠ‚ç‚¹æ•°é‡
  - æä¾›é¢„è§ˆåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
  - åœ¨æ–‡æ¡£ä¸­æ¸…æ™°è¯´æ˜

#### 2. å“åº”èŠ‚ç‚¹ä½ç½®
- **æŒ‘æˆ˜**ï¼šæ–°èŠ‚ç‚¹å¯èƒ½å‡ºç°åœ¨ä¸ç†æƒ³çš„ä½ç½®
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - æä¾›å¯é…ç½®çš„åç§»é‡
  - æœªæ¥å¯ä»¥æ”¯æŒç”¨æˆ·æ‹–åŠ¨è°ƒæ•´

#### 3. å¹¶å‘ç”Ÿæˆçš„è§†è§‰åé¦ˆ
- **æŒ‘æˆ˜**ï¼šå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆï¼Œç”¨æˆ·å¯èƒ½å›°æƒ‘
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - æ¯ä¸ªå“åº”èŠ‚ç‚¹ç‹¬ç«‹æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  - ä½¿ç”¨ä¸åŒçš„ callout é¢œè‰²åŒºåˆ†çŠ¶æ€
  - åœ¨èŠ‚ç‚¹æ ‡é¢˜ä¸­æ˜¾ç¤º"ç”Ÿæˆä¸­..."

## ğŸ“š å‚è€ƒèµ„æº

### Obsidian API
- Canvas API æ–‡æ¡£ï¼ˆå¦‚æœæœ‰ï¼‰
- ItemView å’Œ WorkspaceLeaf API
- Modal ç»„ä»¶ API

### ç¤¾åŒºèµ„æº
- å…¶ä»– Canvas æ’ä»¶çš„å®ç°
- Obsidian å¼€å‘è€…ç¤¾åŒºè®¨è®º
- Canvas æ•°æ®ç»“æ„å’Œæ–‡ä»¶æ ¼å¼ï¼ˆ.canvas æ–‡ä»¶ï¼‰

### ç›¸å…³ä»£ç 
- ç¼–è¾‘å™¨å®ç°ï¼š`src/suggest/ai-editor-suggest.ts`
- UI æ§åˆ¶å™¨ï¼š`src/ui/editor-ui-controller.ts`
- ä¸Šä¸‹æ–‡æå–ï¼š`src/utils/context-extractor.ts`

## ğŸ’¡ å®ç°å»ºè®®

### å¼€å‘é¡ºåº
1. å…ˆå®ç°åŸºç¡€çš„èœå•æŒ‰é’®å’Œæ¨¡æ€æ¡†
2. å®ç°ç®€å•çš„ä¸Šä¸‹æ–‡æå–ï¼ˆä»…å½“å‰èŠ‚ç‚¹ï¼‰
3. å®ç°æ–°èŠ‚ç‚¹åˆ›å»ºå’ŒåŸºç¡€å“åº”æ˜¾ç¤º
4. æ·»åŠ ç›¸å…³èŠ‚ç‚¹ä¸Šä¸‹æ–‡æå–
5. å®ç°æµå¼è¾“å‡º
6. æ·»åŠ å¹¶å‘æ”¯æŒå’Œé”™è¯¯å¤„ç†
7. ä¼˜åŒ–å’Œå®Œå–„

### ä»£ç å¤ç”¨
- å°½å¯èƒ½å¤ç”¨ç¼–è¾‘å™¨çš„å®ç°
  - AIClientï¼šç›´æ¥ä½¿ç”¨
  - ResponseParserï¼šç›´æ¥ä½¿ç”¨
  - ContextExtractorï¼šå‚è€ƒé€»è¾‘ï¼Œåˆ›å»º Canvas ç‰ˆæœ¬
  - ResponseRendererï¼šå‚è€ƒæ ¼å¼ï¼Œé€‚é… Canvas èŠ‚ç‚¹

### è°ƒè¯•æŠ€å·§
- ä½¿ç”¨ `debugMode` è®¾ç½®è®°å½•è¯¦ç»†æ—¥å¿—
- åœ¨æ§åˆ¶å°æŸ¥çœ‹ Canvas å¯¹è±¡ç»“æ„
- ä½¿ç”¨ Obsidian å¼€å‘è€…å·¥å…·æ£€æŸ¥ Canvas DOM

## ğŸ”„ æ›´æ–°æ—¥å¿—

- 2024-02-14ï¼šåˆ›å»ºåˆå§‹æ–‡æ¡£ï¼Œå®šä¹‰åŠŸèƒ½éœ€æ±‚å’Œå®ç°è®¡åˆ’
- 2024-02-14ï¼šæ›´æ–°ä¸ºåŸºäºèœå•æŒ‰é’®çš„å®ç°æ–¹æ¡ˆï¼Œé¿å…ç„¦ç‚¹é—®é¢˜ï¼Œæ”¯æŒå¹¶å‘ç”Ÿæˆ
