# AI Companion

> 通过快捷键灵活控制 AI 上下文的 Obsidian 插件

## 💡 为什么需要这个插件？

在使用 AI 辅助写作和笔记时，我们经常遇到这样的困境：

- **查询陌生词汇**：突然遇到一个不熟悉的概念需要查询，但如果在当前会话中查询，会打断整个对话的连贯性
- **上下文干扰**：有时我们需要 AI 理解前文，有时又希望它只回答当前问题，不受之前内容影响
- **笔记场景特殊**：与纯对话不同，做笔记时更需要精确控制 AI 看到什么、不看到什么

AI Companion 解决了这个问题：**通过不同的快捷键，让你在提交问题时即时决定是否包含上下文**。

## ✨ 核心特性

### ⌨️ 快捷键控制上下文（核心功能）

在编辑器中输入 `/` 后，使用不同快捷键提交问题，控制 AI 看到的上下文：

- **Enter**：遵循设置中的上下文配置（默认）
- **Shift+Enter**：包含光标前的全部内容作为上下文
- **自定义快捷键**：在设置中配置更多快捷键组合，对应不同的上下文范围

这样，你可以在同一个笔记中：
- 用 `Shift+Enter` 让 AI 基于前文继续写作
- 用 `Enter`（无上下文）快速查询一个陌生概念，不影响整体思路
- 灵活切换，保持笔记的连贯性

### 📝 编辑器智能辅助

- **快速触发**：在编辑器中输入 `/` 即可唤起 AI 助手
- **实时响应**：输入问题后立即获得 AI 响应
- **流式输出**：支持逐字显示 AI 响应，实时查看生成过程

### 🎨 Canvas 画布集成 🚧

> ⚠️ **开发中**：Canvas 功能正在开发中，暂未完全实现

- 在 Canvas 节点中同样可以使用 `/` 触发 AI（计划中）
- 支持在思维导图和画布中进行 AI 辅助创作（计划中）

### 🎯 命令面板支持

- **触发 AI 输入**：通过命令面板快速唤起 AI
- **使用选中文本询问 AI**：选中文本后直接提问

### 🎨 美观的 UI 设计

- **Obsidian Markdown 原生渲染**：AI 响应以完整的 Obsidian Markdown 格式显示，支持所有语法（包括 callout、双链等）
- **可自定义颜色**：支持自定义编辑器中 AI 响应的提示颜色
- **加载动画**：优雅的加载指示器
- **错误提示**：清晰的错误信息展示

## 🚀 快速开始

### 安装

1. 下载最新版本的 `main.js`、`manifest.json` 和 `styles.css`
2. 在你的 Vault 中创建文件夹：`<Vault>/.obsidian/plugins/obsidian-ai-companion/`
3. 将下载的文件复制到该文件夹
4. 重启 Obsidian
5. 在 **设置 → 社区插件** 中启用 AI Companion

### 配置 AI 服务

1. 打开 **设置 → AI Companion**
2. 配置你的 AI 服务：
   - **API 端点**：你的 AI 服务地址（默认：DeepSeek API）
   - **API 密钥**：你的 API 密钥
   - **模型名称**：使用的模型（如 `deepseek-chat`）
3. 点击 **测试连接** 验证配置

### 基本使用

1. 在编辑器中输入 `/`
2. 输入你的问题或需求
3. 选择合适的快捷键提交：
   - `Enter`：使用默认上下文设置
   - `Shift+Enter`：包含光标前的全部内容
4. AI 响应会以完整的 Obsidian Markdown 格式插入到光标位置（支持 callout、双链等所有语法）

## 📖 使用场景

### 场景 1：连续写作 + 快速查询

```markdown
我正在写一篇关于量子计算的文章...

[输入 /] 继续扩展量子纠缠的部分
[按 Shift+Enter - 包含上文]
基于你前面提到的量子计算基础，量子纠缠是...
（AI 可能返回包含 callout、列表、代码块等的完整 Markdown）

突然遇到一个术语不理解：

[输入 /] 什么是量子退相干？
[按 Enter - 无上下文，纯粹查询]
> [!note] 量子退相干
> 量子退相干是指...
（AI 可能使用 callout 格式返回）

[输入 /] 那么如何在文章中解释退相干对量子计算的影响？
[按 Shift+Enter - 重新包含上文]
结合你文章的上下文，可以这样解释退相干...
```

### 场景 2：思维整理

```markdown
[输入 /] 总结上面的要点
[按 Shift+Enter]

[输入 /] 从这些内容中提取关键信息
[按 Shift+Enter]

[输入 /] 帮我理清这些概念之间的关系
[按 Shift+Enter]
```

### 场景 3：写作辅助

```markdown
[输入 /] 帮我扩展这段话的论述
[按 Shift+Enter]

[输入 /] 这段文字有什么可以改进的地方
[按 Shift+Enter]

[输入 /] 用更专业的语言重写这段内容
[按 Shift+Enter]
```

## ⚙️ 高级配置

### 上下文提取设置

在 **设置 → AI Companion → 上下文配置** 中：

- **启用上下文**：全局开关，控制是否启用上下文功能
- **上下文范围**：
  - 当前段落
  - 当前章节
  - 整个文档
  - 选中文本
- **最大上下文长度**：控制发送给 AI 的上下文字符数（避免超出 API 限制）

### 快捷键自定义

在 **设置 → AI Companion → 上下文快捷键** 中：

1. 查看现有快捷键配置
2. 点击快捷键按钮修改组合键
3. 选择对应的上下文类型：
   - **无上下文**：纯粹问答，不包含任何上下文
   - **光标前全部内容**：包含光标前的所有文本
   - **遵循设置**：使用上下文配置中的范围设置
4. 可以添加多个快捷键配置，满足不同使用场景

### 样式自定义

- 自定义 AI 响应 Callout 的颜色
- 支持 RGB 和 HEX 颜色格式
- 分别设置输出中和输出完成的颜色
- 实时预览效果

## 🔧 开发

### 环境要求

- Node.js 18+
- npm

### 安装依赖

```bash
npm install
```

### 开发模式

```bash
npm run dev
```

### 构建

```bash
npm run build
```

### 测试

```bash
npm run test
npm run test:coverage
```

### 代码检查

```bash
npm run lint
```

## 📁 项目结构

```
src/
├── main.ts                 # 插件入口
├── settings.ts             # 设置界面
├── commands/               # 命令注册
├── services/               # 核心服务
│   ├── ai-client.ts       # AI 客户端
│   ├── request-queue.ts   # 请求队列
│   └── response-parser.ts # 响应解析
├── ui/                     # UI 组件
│   ├── editor-ui-controller.ts
│   ├── loading-indicator.ts
│   └── error-display.ts
├── suggest/                # 建议系统
│   └── ai-editor-suggest.ts
├── canvas/                 # Canvas 集成（开发中）
│   ├── canvas-trigger-handler.ts
│   └── canvas-ui-controller.ts
└── utils/                  # 工具函数
    ├── context-extractor.ts
    └── error-handler.ts
```

## 🔒 隐私与安全

- **本地优先**：插件本身不收集任何数据
- **API 通信**：仅在你主动触发时才与配置的 AI 服务通信
- **数据控制**：你完全控制发送给 AI 的内容
- **透明配置**：所有设置都在本地，清晰可见

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

0-BSD License

## 🙏 致谢

感谢 Obsidian 社区的支持和反馈。

---

**注意**：此插件需要配置有效的 AI 服务才能使用。请确保你有可用的 API 端点和密钥。
